<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reservar â€” Hotel el RincÃ³n del Carmen</title>
<link rel="stylesheet" href="css/bootstrap/bootstrap.css">
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
<site-navbar></site-navbar>

<main class="container my-5">
  <h1 class="section-title mb-3">Reserva tu estancia</h1>
  <div id="bar"></div>
  <div class="mt-3 row row-cols-2 row-cols-md-3 g-3" id="results"></div>
</main>

<!-- Modal de Reserva con PolÃ­ticas -->
<reservation-modal></reservation-modal>

<site-footer></site-footer>

<script src="js/bootstrap/bootstrap.bundle.js"></script>
<script type="module">
  import './app.js';
  import './js/components/navbar.js';
  import './js/components/footer.js';
  import './js/components/reservationModal.js';
  import { bookingBar } from './js/components/bookingBar.js';
  import { searchAvailable } from './js/services/reservationService.js';
  import { currentUser } from './js/services/authService.js';
  import { toast } from './js/utils/ui.js';

  document.getElementById('bar').innerHTML = bookingBar();
  const results = document.getElementById('results');
  const resModal = document.querySelector('reservation-modal');

  function render(list){
    results.innerHTML = list.map(r=>{
      const photo = (r.photos && r.photos[0]) || 'https://picsum.photos/seed/fallback/1200/800';
      return `
      <div class="col">
        <div class="card room-card h-100">
          <img src="${photo}" class="card-img-top" alt="${r.name}">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title">${r.name}</h6>
            <small class="text-secondary mb-2">${r.maxGuests} huÃ©spedes Â· ${r.beds} camas</small>
            <div class="mt-auto d-flex justify-content-between align-items-center">
              <span class="price">$${r.price.toLocaleString('es-CO')}</span>
              <button class="btn btn-sm btn-primary" data-book="${r.id}">Reservar</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function onSearch(){
    const from = document.getElementById('bkFrom').value;
    const to = document.getElementById('bkTo').value;
    const guests = Number(document.getElementById('bkGuests').value);
    const list = searchAvailable({ from, to, guests });
    render(list);
  }

  document.getElementById('btnSearch').addEventListener('click', onSearch);
  onSearch();

  // ðŸ†• Abrir modal de reserva en lugar de reservar directo
  results.addEventListener('click', (ev)=>{
    const id = ev.target?.dataset?.book;
    if (!id) return;
    const me = currentUser();
    if (!me){
      toast('Debes iniciar sesiÃ³n','warning');
      return;
    }
    const from = document.getElementById('bkFrom').value;
    const to = document.getElementById('bkTo').value;
    const guests = Number(document.getElementById('bkGuests').value);

    resModal.open({ roomId: id, from, to, guests });
  });
</script>
</body>
</html>
